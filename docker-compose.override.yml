# Configuration override pour DÉVELOPPEMENT
# Ce fichier est automatiquement chargé par Docker Compose
# Ajoute les services et configurations spécifiques au développement

services:
  frankenphp:
    build:
      target: development
    ports:
      - "${HTTP_PORT:-8080}:80"
      - "${PHPMYADMIN_PORT:-8082}:8082"
      - "${MAILHOG_PORT:-8027}:8027"
    volumes:
      # Bind mount pour édition en temps réel
      - ./app:/var/www/html
      - ./docker/Caddyfile.dev:/etc/caddy/Caddyfile
    environment:
      # Variables pour gestion des droits
      - DOCKER_UID=${DOCKER_UID:-1000}
      - DOCKER_GID=${DOCKER_GID:-1000}
      # Variables Symfony développement
      - APP_ENV=dev
      - APP_DEBUG=1
      # Base de données développement
      - DATABASE_URL=mysql://${DB_USER:-app_user}:${DB_PASSWORD:-app_password}@mariadb:3306/${DB_NAME:-app_db}?serverVersion=${MARIADB_VERSION:-11}.0.0-MariaDB&charset=utf8mb4
      # API externes
      - CFI_API_BASE_URL=${CFI_API_BASE_URL}
      - CFI_API_CLEF=${CFI_API_CLEF}
      - CFI_API_TIMEOUT=${CFI_API_TIMEOUT}
      - CFI_TOKEN_TTL=${CFI_TOKEN_TTL}
      - CFI_TOKEN_REFRESH_THRESHOLD=${CFI_TOKEN_REFRESH_THRESHOLD}
      - MISTRAL_API_KEY=${MISTRAL_API_KEY}
      - MISTRAL_IMAGE_AGENT_ID=${MISTRAL_IMAGE_AGENT_ID}
      - SERP_API_KEY=${SERP_API_KEY}
      - FIRECRAWL_API_KEY=${FIRECRAWL_API_KEY}
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - GOOGLE_CLIENT_REFRESH_TOKEN=${GOOGLE_CLIENT_REFRESH_TOKEN}
      - GOOGLE_CLIENT_CUSTOMER_ID=${GOOGLE_CLIENT_CUSTOMER_ID}
      - GOOGLE_CLIENT_CM_ID=${GOOGLE_CLIENT_CM_ID}
      - GOOGLE_TOKEN_DEV=${GOOGLE_TOKEN_DEV}
    # Healthcheck personnalisé pour FrankenPHP
    healthcheck:
      test: ["CMD-SHELL", "php -v || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    # Logs détaillés pour le développement
    tty: true

  # Services additionnels pour le développement
  phpmyadmin:
    image: phpmyadmin/phpmyadmin:${PHPMYADMIN_VERSION:-latest}
    container_name: ${PROJECT_NAME}_phpmyadmin
    restart: unless-stopped
    environment:
      PMA_HOST: mariadb
      PMA_USER: ${DB_USER:-app_user}
      PMA_PASSWORD: ${DB_PASSWORD:-app_password}
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-root}
    depends_on:
      mariadb:
        condition: service_healthy
    networks:
      - app_network

  mailhog:
    image: mailhog/mailhog:${MAILHOG_VERSION:-latest}
    container_name: ${PROJECT_NAME}_mailhog
    restart: unless-stopped
    environment:
      # Configuration MailHog
      MH_STORAGE: memory
      MH_UI_BIND_ADDR: 0.0.0.0:8025
      MH_API_BIND_ADDR: 0.0.0.0:8025
    networks:
      - app_network

  # Configuration Mercure pour développement
  # Note: Port mapping désactivé - Mercure accessible via proxy FrankenPHP sur port 8080 (hôte) → 80 (conteneur)
  # URL: http://localhost:8080/.well-known/mercure (plus de problème CORS/Same-Origin)
  mercure:
    # ports:
    #   - "${MERCURE_PORT:-3001}:80"  # Désactivé - utiliser proxy Caddy
    environment:
      MERCURE_EXTRA_DIRECTIVES: |
        cors_origins http://localhost:${HTTP_PORT:-8080} http://127.0.0.1:${HTTP_PORT:-8080} http://0.0.0.0:${HTTP_PORT:-8080}
        anonymous
        demo

  # Configuration ChromaDB pour développement
  chroma:
    ports:
      - "${CHROMA_PORT:-8000}:8000"
    volumes:
      - chroma_data:/chroma/chroma
    environment:
      - IS_PERSISTENT=TRUE
      - ANONYMIZED_TELEMETRY=FALSE

  # Configuration Messenger Worker pour développement
  messenger_worker:
    environment:
      # Base de données développement (nécessaire pour accéder à messenger_messages)
      - DATABASE_URL=mysql://${DB_USER:-app_user}:${DB_PASSWORD:-app_password}@mariadb:3306/${DB_NAME:-app_db}?serverVersion=${MARIADB_VERSION:-11}.0.0-MariaDB&charset=utf8mb4
      # Variables pour Messenger
      - MESSENGER_TRANSPORT_DSN=doctrine://default?queue_name=async

volumes:
  chroma_data:
    name: ${PROJECT_NAME}_chroma_data
