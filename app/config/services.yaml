# This file is the entry point to configure your own services.
# Files in the packages/ subdirectory configure your dependencies.

# Put parameters here that don't need to change on each machine where the app is deployed
# https://symfony.com/doc/current/best_practices.html#use-parameters-for-application-configuration
parameters:
    # API CFI Configuration
    cfi.api.base_url: '%env(CFI_API_BASE_URL)%'
    cfi.api.clef: '%env(CFI_API_CLEF)%'
    cfi.api.timeout: '%env(int:CFI_API_TIMEOUT)%'
    cfi.token.ttl: '%env(int:CFI_TOKEN_TTL)%'
    cfi.token.refresh_threshold: '%env(int:CFI_TOKEN_REFRESH_THRESHOLD)%'

    # Mercure Hub Configuration (Sprint S1+)
    # URL du hub Mercure pour le streaming temps réel
    # Défaut vide pour MVP Sprint S1 (mode sync uniquement)
    mercure.default_hub: '%env(default::MERCURE_PUBLIC_URL)%'

    # Feature Flags - Authentification
    # Activer le mode d'authentification email/password (false en attendant endpoint CFI)
    cfi.auth.credentials_enabled: false

services:
    # default configuration for services in *this* file
    _defaults:
        autowire: true      # Automatically injects dependencies in your services.
        autoconfigure: true # Automatically registers your services as commands, event subscribers, etc.

    # makes classes in src/ available to be used as services
    # this creates a service per class whose id is the fully-qualified class name
    App\:
        resource: '../src/'

    # add more service definitions when explicit configuration is needed
    # please note that last definitions always *replace* previous ones

    # Symfony AI - Token Usage Tracking
    # Active TokenOutputProcessor de Mistral pour capturer token_usage
    # Fonctionne UNIQUEMENT en mode non-streaming (voir Bridge/Mistral/TokenOutputProcessor.php:27-30)
    Symfony\AI\Platform\Bridge\Mistral\TokenOutputProcessor:
        tags:
            - { name: 'ai.output_processor', priority: 100 }

    # OutputProcessor personnalisé pour capturer le champ "model" (non capturé par TokenOutputProcessor)
    # Priorité 200 pour s'exécuter APRÈS TokenOutputProcessor
    App\Service\Ai\MistralMetadataProcessor:
        tags:
            - { name: 'ai.output_processor', priority: 200 }

    # CFI API Service Configuration
    App\Service\Cfi\CfiApiService:
        arguments:
            $cfiApiBaseUrl: '%cfi.api.base_url%'
            $cfiApiTimeout: '%cfi.api.timeout%'

    App\Service\Cfi\CfiAuthService:
        arguments:
            $clefApi: '%cfi.api.clef%'

    App\Service\Cfi\CfiSessionService:
        arguments:
            $tokenTtl: '%cfi.token.ttl%'
            $tokenRefreshThreshold: '%cfi.token.refresh_threshold%'

    App\Controller\ChatController:
        arguments:
            $mercurePublicUrl: '%mercure.default_hub%'

    # Service de génération JWT Mercure pour authentification EventSource
    App\Service\MercureJwtGenerator:
        arguments:
            $mercureJwtSecret: '%env(MERCURE_JWT_SECRET)%'

    # ToolResultCollector - Service singleton pour collecter les résultats des tools
    # IMPORTANT : shared: true pour garantir une instance unique partagée entre tous les services
    App\Service\ToolResultCollector:
        shared: true
