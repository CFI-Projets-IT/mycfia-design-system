/**
 * marketing_project_new.js
 * Gestion de l'enrichissement IA du formulaire de cr√©ation de projet marketing
 *
 * Fonctionnalit√©s :
 * - Soumission AJAX pour enrichissement IA
 * - Connexion EventSource Mercure pour notifications temps r√©el
 * - Affichage des r√©sultats dans une modal Bootstrap
 * - Acceptation et application des suggestions IA
 */

/**
 * Initialise le script d'enrichissement
 * @param {Object} config - Configuration depuis data attributes
 * @param {string} config.mercureUrl - URL publique du hub Mercure
 * @param {string} config.enrichmentResultsUrl - URL pour r√©cup√©rer les r√©sultats (avec __TASK_ID__ placeholder)
 * @param {string} config.enrichmentAcceptUrl - URL pour accepter les suggestions (avec __TASK_ID__ placeholder)
 */
export function initMarketingProjectEnrichment(config) {
    console.log('üöÄ Initialisation enrichissement IA');

    const form = document.querySelector('form[name="project"]');
    const analyzeBtn = document.querySelector('button[name="project[analyze]"]');
    const enrichmentModal = new bootstrap.Modal(document.getElementById('enrichmentModal'));
    const mercurePublicUrl = config.mercureUrl;

    let currentTaskId = null;
    let eventSource = null;
    let alternativeNames = [];

    // V√©rifications initiales
    if (!analyzeBtn) {
        console.error('‚ùå Bouton "Analyser avec IA" introuvable');
        return;
    }

    console.log('‚úÖ Bouton trouv√©, attachement du listener');

    // === EVENT: Clic sur "Analyser avec IA" ===
    analyzeBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();

        // Validation formulaire
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        // Soumettre via AJAX
        submitForEnrichment();
    });

    /**
     * Soumet le formulaire pour enrichissement IA
     */
    function submitForEnrichment() {
        const formData = new FormData(form);
        formData.append('analyze', '1'); // Marqueur pour d√©tection c√¥t√© serveur

        console.log('=== FormData envoy√© ===');
        for (const [key, value] of formData.entries()) {
            console.log(`${key}:`, value instanceof File ? value.name : value);
        }

        fetch(form.action, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            },
            body: formData,
        })
            .then((response) =>
                response.json().then((data) => ({
                    ok: response.ok,
                    status: response.status,
                    data: data,
                }))
            )
            .then(({ ok, data }) => {
                if (ok && data.success) {
                    currentTaskId = data.taskId;
                    openModalWithLoader();
                    connectToMercure(data.taskId);
                } else {
                    handleSubmitError(data);
                }
            })
            .catch((error) => {
                console.error('‚ùå Erreur AJAX:', error);
                alert(`Erreur de connexion au serveur: ${error.message}`);
            });
    }

    /**
     * G√®re les erreurs de soumission
     */
    function handleSubmitError(data) {
        let errorMessage = data.error || "Erreur lors du d√©marrage de l'enrichissement";

        if (data.validation_errors && data.validation_errors.length > 0) {
            errorMessage = `Veuillez corriger les erreurs suivantes :\n${data.validation_errors.join('\n')}`;
        }

        alert(errorMessage);
        console.error('‚ùå Erreur validation:', data);
    }

    /**
     * Ouvre la modal avec le loader actif
     */
    function openModalWithLoader() {
        document.getElementById('enrichmentLoader').style.display = 'block';
        document.getElementById('enrichmentResults').style.display = 'none';
        document.getElementById('enrichmentError').style.display = 'none';
        document.getElementById('acceptEnrichmentBtn').style.display = 'none';

        enrichmentModal.show();
    }

    /**
     * Connexion au hub Mercure pour √©couter les √©v√©nements de t√¢che
     * @param {string} taskId - ID de la t√¢che asynchrone
     */
    function connectToMercure(taskId) {
        const url = `${mercurePublicUrl}?topic=/tasks/${taskId}`;
        console.log('üì° Connexion Mercure:', url);

        eventSource = new EventSource(url);

        // Mercure envoie tous les √©v√©nements via le type 'message' par d√©faut
        eventSource.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                console.log('üì® √âv√©nement Mercure re√ßu:', data);

                switch (data.type) {
                    case 'TaskStartedEvent':
                        console.log('üü¢ TaskStartedEvent re√ßu');
                        break;

                    case 'TaskCompletedEvent':
                        console.log('‚úÖ TaskCompletedEvent re√ßu');
                        closeEventSource();
                        fetchEnrichmentResults(taskId);
                        break;

                    case 'TaskFailedEvent':
                        console.error('‚ùå TaskFailedEvent re√ßu');
                        closeEventSource();
                        showError("L'enrichissement a √©chou√©. Veuillez r√©essayer.");
                        break;

                    default:
                        console.warn('‚ö†Ô∏è Type √©v√©nement inconnu:', data.type);
                }
            } catch (error) {
                console.error('‚ùå Erreur parsing √©v√©nement Mercure:', error);
            }
        };

        eventSource.onerror = (error) => {
            console.error('‚ùå EventSource error:', error);
        };
    }

    /**
     * Ferme la connexion EventSource
     */
    function closeEventSource() {
        if (eventSource) {
            eventSource.close();
            eventSource = null;
        }
    }

    /**
     * R√©cup√®re les r√©sultats d'enrichissement via AJAX
     * @param {string} taskId - ID de la t√¢che
     */
    function fetchEnrichmentResults(taskId) {
        const url = config.enrichmentResultsUrl.replace('__TASK_ID__', taskId);

        fetch(url)
            .then((response) => response.json())
            .then((data) => {
                if (data.success) {
                    displayResults(data.results);
                } else {
                    showError(data.error || 'Erreur lors de la r√©cup√©ration des r√©sultats');
                }
            })
            .catch((error) => {
                console.error('‚ùå Erreur r√©cup√©ration r√©sultats:', error);
                showError('Erreur de connexion au serveur');
            });
    }

    /**
     * Affiche les r√©sultats d'enrichissement dans la modal
     * @param {Object} results - R√©sultats depuis le cache
     */
    function displayResults(results) {
        document.getElementById('enrichmentLoader').style.display = 'none';
        document.getElementById('enrichmentResults').style.display = 'block';
        document.getElementById('acceptEnrichmentBtn').style.display = 'inline-block';

        console.log('üìä Affichage des r√©sultats enrichissement (v3.1.0):', results);

        // Structure v3.1.0 simplifi√©e (DTO ProjectEnrichmentOutput)
        const mappedResults = {
            alternative_names: results.creative_name_alternatives || [],
            smart_objectives: results.smart_objectives_detailed || '',
            strategic_recommendations: results.strategic_recommendations || [],
            success_factors: results.success_factors || [],
        };

        console.log('üìä Structure mapp√©e v3.1.0:', mappedResults);

        // Stocker les noms alternatifs
        alternativeNames = mappedResults.alternative_names;

        // Stocker les objectifs (maintenant STRING) pour acceptEnrichment
        window.currentEnrichedObjectives = mappedResults.smart_objectives || '';

        // 1. Afficher les noms alternatifs avec radio buttons
        renderAlternativeNames(mappedResults.alternative_names);

        // 2. Afficher objectifs SMART (STRING texte format√©)
        renderSmartObjectives('objectivesDetailContainer', mappedResults.smart_objectives);

        // 3. Afficher recommandations strat√©giques (array de strings)
        renderRecommendations('recommendationsContainer', mappedResults.strategic_recommendations);

        // 4. Afficher facteurs cl√©s de succ√®s (array de strings)
        renderSuccessFactors('successFactorsContainer', mappedResults.success_factors);
    }

    /**
     * Affiche les objectifs SMART dans un conteneur HTML format√©
     * @param {string} containerId - ID du conteneur
     * @param {Object|string} objectives - Objectifs SMART (objet ou string)
     */
    function renderSmartObjectives(containerId, objectives) {
        const container = document.getElementById(containerId);

        if (!objectives) {
            container.innerHTML = '<p class="text-muted">Aucun objectif disponible</p>';
            return;
        }

        // Si c'est une string, afficher simplement
        if (typeof objectives === 'string') {
            container.innerHTML = `<div class="card"><div class="card-body"><pre class="mb-0">${escapeHtml(objectives)}</pre></div></div>`;
            return;
        }

        // Si c'est un objet, formatter de mani√®re structur√©e
        let html = '';

        // G√©rer les deux formats : principal / objectif_principal
        const principal = objectives.principal || objectives.objectif_principal;

        if (principal) {
            html += '<div class="card mb-3 border-warning"><div class="card-header bg-warning text-dark fw-bold">';
            html += '<i class="bi bi-star-fill"></i> Objectif Principal</div><div class="card-body">';

            // Description
            if (principal.description) {
                html += `<p class="lead mb-4">${escapeHtml(principal.description)}</p>`;
            }

            // === METRICS (notoriete_spontanee, reseaux_sociaux, trafic_qualifie, medias_earned) ===
            if (principal.metrics && typeof principal.metrics === 'object') {
                html += '<h6 class="fw-bold text-primary mb-3"><i class="bi bi-graph-up-arrow"></i> M√©triques Principales</h6>';
                html += '<div class="row mb-4">';

                Object.entries(principal.metrics).forEach(([key, metrique]) => {
                    const label = key.replace(/_/g, ' ').replace(/\b\w/g, (l) => l.toUpperCase());
                    html += '<div class="col-md-6 mb-3">';
                    html += '<div class="card border-primary h-100">';
                    html += `<div class="card-header bg-primary bg-opacity-10 fw-bold">${escapeHtml(label)}</div>`;
                    html += '<div class="card-body">';

                    if (typeof metrique === 'object' && metrique !== null) {
                        Object.entries(metrique).forEach(([subKey, subValue]) => {
                            const subLabel = subKey.replace(/_/g, ' ').replace(/\b\w/g, (l) => l.toUpperCase());
                            html += `<p class="mb-2"><strong class="text-primary">${escapeHtml(subLabel)}:</strong><br>${escapeHtml(valueToString(subValue))}</p>`;
                        });
                    } else {
                        html += `<p class="mb-0">${escapeHtml(valueToString(metrique))}</p>`;
                    }

                    html += '</div></div></div>';
                });

                html += '</div>';
            }

            // === CRIT√àRES MESURABLES (quantitatifs, qualitatifs) ===
            if (principal.crit√®res_mesurables && typeof principal.crit√®res_mesurables === 'object') {
                html += '<h6 class="fw-bold text-success mb-3"><i class="bi bi-clipboard-data"></i> Crit√®res Mesurables</h6>';
                html += '<div class="row mb-4">';

                // Quantitatifs
                if (principal.crit√®res_mesurables.quantitatifs?.length > 0) {
                    html += '<div class="col-md-6 mb-3">';
                    html += '<div class="card border-success h-100">';
                    html += '<div class="card-header bg-success bg-opacity-10 fw-bold"><i class="bi bi-bar-chart"></i> Quantitatifs</div>';
                    html += '<div class="card-body"><ul class="mb-0">';
                    principal.crit√®res_mesurables.quantitatifs.forEach((critere) => {
                        html += `<li class="mb-2">${escapeHtml(critere)}</li>`;
                    });
                    html += '</ul></div></div></div>';
                }

                // Qualitatifs
                if (principal.crit√®res_mesurables.qualitatifs?.length > 0) {
                    html += '<div class="col-md-6 mb-3">';
                    html += '<div class="card border-info h-100">';
                    html += '<div class="card-header bg-info bg-opacity-10 fw-bold"><i class="bi bi-chat-quote"></i> Qualitatifs</div>';
                    html += '<div class="card-body"><ul class="mb-0">';
                    principal.crit√®res_mesurables.qualitatifs.forEach((critere) => {
                        html += `<li class="mb-2">${escapeHtml(critere)}</li>`;
                    });
                    html += '</ul></div></div></div>';
                }

                html += '</div>';
            }

            // === CRIT√àRES DE SUCC√àS (array d'objets avec indicateur, mesure, source) ===
            if (principal.crit√®res_succ√®s?.length > 0 || principal.criteres_succes?.length > 0) {
                const criteres = principal.crit√®res_succ√®s || principal.criteres_succes;
                html += '<h6 class="fw-bold text-success mb-3"><i class="bi bi-trophy"></i> Crit√®res de Succ√®s</h6>';
                html += '<div class="accordion mb-4" id="criteresAccordion">';

                criteres.forEach((critere, index) => {
                    if (typeof critere === 'object') {
                        const indicateur = critere.indicateur || critere.critere || `Crit√®re ${index + 1}`;
                        const mesure = critere.mesure || critere.valeur || '';
                        const source = critere.source || '';

                        html += `<div class="accordion-item">`;
                        html += `<h2 class="accordion-header" id="heading${index}">`;
                        html += `<button class="accordion-button ${index > 0 ? 'collapsed' : ''}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${index}">`;
                        html += `<i class="bi bi-check-circle text-success me-2"></i> ${escapeHtml(indicateur)}`;
                        html += `</button></h2>`;
                        html += `<div id="collapse${index}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" data-bs-parent="#criteresAccordion">`;
                        html += `<div class="accordion-body">`;
                        if (mesure) html += `<p class="mb-2"><strong>Mesure:</strong> ${escapeHtml(mesure)}</p>`;
                        if (source) html += `<p class="mb-0 text-muted small"><strong>Source:</strong> ${escapeHtml(source)}</p>`;
                        html += `</div></div></div>`;
                    } else {
                        html += `<div class="alert alert-success mb-2" role="alert"><i class="bi bi-check-circle me-2"></i>${escapeHtml(String(critere))}</div>`;
                    }
                });

                html += '</div>';
            }

            // === TIMELINE (phases avec actions et KPI) ===
            if (principal.timeline) {
                html += '<h6 class="fw-bold text-info mb-3"><i class="bi bi-calendar3"></i> Timeline et Jalons</h6>';

                if (principal.timeline.jalon_cle) {
                    html += `<div class="alert alert-info mb-3"><i class="bi bi-flag-fill me-2"></i><strong>Jalon Cl√©:</strong> ${escapeHtml(principal.timeline.jalon_cle)}</div>`;
                }

                // G√©rer les deux formats : timeline.phases (array) OU phase_1_*, phase_2_*, etc. (object keys)
                const phases = [];
                if (principal.timeline.phases?.length > 0) {
                    phases.push(...principal.timeline.phases);
                } else {
                    // Extraire les phases depuis les cl√©s phase_1_*, phase_2_*, etc.
                    Object.keys(principal.timeline)
                        .filter((key) => key.startsWith('phase_'))
                        .sort()
                        .forEach((key) => {
                            const phase = principal.timeline[key];
                            if (typeof phase === 'object') {
                                // Ajouter le nom de la cl√© comme propri√©t√© "nom" si absent
                                if (!phase.nom) {
                                    phase.nom = key.replace(/_/g, ' ').replace(/\b\w/g, (l) => l.toUpperCase());
                                }
                                phases.push(phase);
                            }
                        });
                }

                if (phases.length > 0) {
                    html += '<div class="timeline mb-4">';

                    phases.forEach((phase, index) => {
                        const phaseName = phase.nom || `Phase ${index + 1}`;
                        const duree = phase.duree || '';

                        html += `<div class="card mb-3 border-info">`;
                        html += `<div class="card-header bg-info bg-opacity-10">`;
                        html += `<strong><i class="bi bi-calendar-event me-2"></i>${escapeHtml(phaseName)}</strong>`;
                        if (duree) html += ` <span class="badge bg-info">${escapeHtml(duree)}</span>`;
                        html += `</div><div class="card-body">`;

                        // Actions
                        if (phase.actions?.length > 0) {
                            html += '<div class="mb-3"><p class="fw-bold mb-2 text-primary"><i class="bi bi-list-ul me-1"></i>Actions:</p><ul class="mb-0">';
                            phase.actions.forEach((action) => {
                                html += `<li class="mb-1">${escapeHtml(action)}</li>`;
                            });
                            html += '</ul></div>';
                        }

                        // Livrables
                        if (phase.livrables?.length > 0) {
                            html += '<div class="mb-3"><p class="fw-bold mb-2 text-success"><i class="bi bi-box-seam me-1"></i>Livrables:</p><ul class="mb-0">';
                            phase.livrables.forEach((livrable) => {
                                html += `<li class="mb-1">${escapeHtml(livrable)}</li>`;
                            });
                            html += '</ul></div>';
                        }

                        // Budget allou√©
                        if (phase.budget_alloue && typeof phase.budget_alloue === 'object') {
                            html += '<div class="mb-3"><p class="fw-bold mb-2 text-warning"><i class="bi bi-cash-coin me-1"></i>Budget Allou√©:</p>';
                            html += '<div class="row">';
                            Object.entries(phase.budget_alloue).forEach(([key, value]) => {
                                const label = key.replace(/_/g, ' ').replace(/\b\w/g, (l) => l.toUpperCase());
                                html += `<div class="col-md-4 mb-2"><span class="badge bg-warning text-dark">${escapeHtml(label)}: ${escapeHtml(String(value))}</span></div>`;
                            });
                            html += '</div></div>';
                        }

                        // Objectifs de la phase
                        if (phase.objectifs && typeof phase.objectifs === 'object') {
                            html += '<div class="mb-3"><p class="fw-bold mb-2 text-danger"><i class="bi bi-bullseye me-1"></i>Objectifs:</p>';
                            html += '<div class="row">';
                            Object.entries(phase.objectifs).forEach(([key, value]) => {
                                const label = key.replace(/_/g, ' ').replace(/\b\w/g, (l) => l.toUpperCase());
                                html += `<div class="col-md-4 mb-2"><span class="badge bg-danger">${escapeHtml(label)}: ${escapeHtml(String(value))}</span></div>`;
                            });
                            html += '</div></div>';
                        }

                        // KPI
                        if (phase.kpi && typeof phase.kpi === 'object') {
                            html += '<div class="mb-0"><p class="fw-bold mb-2 text-info"><i class="bi bi-graph-up me-1"></i>KPI:</p>';
                            html += '<div class="row">';
                            Object.entries(phase.kpi).forEach(([kpiKey, kpiValue]) => {
                                const kpiLabel = kpiKey.replace(/_/g, ' ').replace(/\b\w/g, (l) => l.toUpperCase());
                                html += `<div class="col-md-4 mb-2"><span class="badge bg-primary">${escapeHtml(kpiLabel)}: ${escapeHtml(String(kpiValue))}</span></div>`;
                            });
                            html += '</div></div>';
                        }

                        html += `</div></div>`;
                    });

                    html += '</div>';
                }
            }

            html += '</div></div>';
        }

        // === OBJECTIFS SECONDAIRES ===
        const secondaires = objectives.secondaires || objectives.objectifs_secondaires;
        if (secondaires?.length > 0) {
            html += '<div class="card border-secondary"><div class="card-header bg-secondary bg-opacity-10 fw-bold">';
            html += '<i class="bi bi-list-check"></i> Objectifs Secondaires</div><div class="card-body">';

            secondaires.forEach((obj, index) => {
                const description = obj.description || obj.objectif || '';
                html += `<div class="mb-3 ${index < secondaires.length - 1 ? 'border-bottom pb-3' : ''}">`;
                html += `<h6 class="fw-bold text-secondary mb-2">${index + 1}. ${escapeHtml(description)}</h6>`;

                // M√©triques des secondaires
                if (obj.metriques && typeof obj.metriques === 'object') {
                    html += '<div class="row mt-2">';
                    Object.entries(obj.metriques).forEach(([key, metrique]) => {
                        const label = key.replace(/_/g, ' ').replace(/\b\w/g, (l) => l.toUpperCase());
                        html += '<div class="col-md-6 mb-2">';
                        html += `<small class="text-muted"><strong>${escapeHtml(label)}:</strong> ${escapeHtml(valueToString(metrique))}</small>`;
                        html += '</div>';
                    });
                    html += '</div>';
                }

                html += '</div>';
            });

            html += '</div></div>';
        }

        container.innerHTML = html || '<p class="text-muted">Aucun objectif structur√© disponible</p>';
    }

    /**
     * Formate les objectifs SMART depuis un objet complexe vers du texte lisible (conserv√© pour acceptEnrichment)
     * @param {Object} objectives - Objet smart_objectives_detailed
     * @returns {string} Texte format√©
     */
    function formatSmartObjectives(objectives) {
        let text = '';

        // G√©rer les deux formats : principal / objectif_principal
        const principal = objectives.principal || objectives.objectif_principal;

        if (principal) {
            text += '=== OBJECTIF PRINCIPAL ===\n\n';
            text += (principal.description || '') + '\n\n';

            // M√©triques (ancien format : metriques_concretes, nouveau : metriques.quantitatives + qualitatives)
            if (principal.metriques) {
                if (principal.metriques.quantitatives && principal.metriques.quantitatives.length > 0) {
                    text += 'M√âTRIQUES QUANTITATIVES:\n';
                    principal.metriques.quantitatives.forEach((metrique) => {
                        text += `‚Ä¢ ${metrique}\n`;
                    });
                    text += '\n';
                }

                if (principal.metriques.qualitatives && principal.metriques.qualitatives.length > 0) {
                    text += 'M√âTRIQUES QUALITATIVES:\n';
                    principal.metriques.qualitatives.forEach((metrique) => {
                        text += `‚Ä¢ ${metrique}\n`;
                    });
                    text += '\n';
                }
            } else if (principal.metriques_concretes) {
                text += 'M√âTRIQUES CONCR√àTES:\n';
                Object.entries(principal.metriques_concretes).forEach(([key, value]) => {
                    text += `‚Ä¢ ${key.replace(/_/g, ' ')}: ${value}\n`;
                });
                text += '\n';
            }

            // Crit√®res (nouveau format : crit√®res_succes)
            if (principal.crit√®res_succes && principal.crit√®res_succes.length > 0) {
                text += 'CRIT√àRES DE SUCC√àS:\n';
                principal.crit√®res_succes.forEach((critere) => {
                    if (typeof critere === 'string') {
                        text += `‚Ä¢ ${critere}\n`;
                    } else if (critere.critere) {
                        text += `‚Ä¢ ${critere.critere}\n`;
                    }
                });
                text += '\n';
            } else if (principal.crit√®res_mesurables) {
                text += 'CRIT√àRES MESURABLES:\n';
                Object.entries(principal.crit√®res_mesurables).forEach(([key, value]) => {
                    text += `‚Ä¢ ${key.replace(/_/g, ' ')}: ${value}\n`;
                });
                text += '\n';
            }
        }

        // Objectifs secondaires (ancien : objectifs_secondaires, nouveau : secondaires)
        const secondaires = objectives.secondaires || objectives.objectifs_secondaires;
        if (secondaires && secondaires.length > 0) {
            text += '\n=== OBJECTIFS SECONDAIRES ===\n\n';
            secondaires.forEach((obj, index) => {
                text += `${index + 1}. ${obj.description || obj.objectif || JSON.stringify(obj)}\n\n`;
            });
        }

        return text.trim();
    }

    /**
     * Affiche les noms alternatifs avec radio buttons
     * @param {Array<string>} names - Liste des noms alternatifs
     */
    function renderAlternativeNames(names) {
        const container = document.getElementById('alternativeNamesContainer');
        container.innerHTML = names
            .map(
                (name, index) => `
            <div class="form-check mb-2">
                <input class="form-check-input" type="radio" name="selectedName" id="name${index}" value="${index}" ${index === 0 ? 'checked' : ''}>
                <label class="form-check-label fw-semibold" for="name${index}">
                    ${escapeHtml(name)}
                </label>
            </div>
        `
            )
            .join('');
    }

    /**
     * Affiche une liste d'√©l√©ments
     * @param {string} containerId - ID du conteneur
     * @param {Array<string>} items - Liste des √©l√©ments
     * @param {string} textClass - Classe CSS pour le texte
     */
    function renderList(containerId, items, textClass) {
        const container = document.getElementById(containerId);

        if (items && items.length > 0) {
            container.innerHTML = `<ul class="mb-0">${items
                .map((item) => `<li class="${textClass} mb-2">${escapeHtml(item)}</li>`)
                .join('')}</ul>`;
        } else {
            container.innerHTML = '<p class="text-muted">Aucune donn√©e disponible</p>';
        }
    }

    /**
     * Affiche les m√©triques et analytics dans un conteneur format√©
     * @param {string} containerId - ID du conteneur
     * @param {Object} results - R√©sultats complets d'enrichissement
     */
    function renderMetrics(containerId, results) {
        const container = document.getElementById(containerId);

        let html = '<div class="row g-3">';

        // === Section M√©triques depuis enhanced_objectives (si disponible) ===
        const principal = results.enhanced_objectives?.principal || results.enhanced_objectives?.objectif_principal;
        if (principal?.metriques) {
            // M√©triques quantitatives (g√©rer les deux formats : quantitatives OU quantitatif)
            const quantitatives = principal.metriques.quantitatives || principal.metriques.quantitatif;
            if (quantitatives && Object.keys(quantitatives).length > 0) {
                html += '<div class="col-md-6">';
                html += '<div class="card h-100 border-primary">';
                html += '<div class="card-header bg-primary text-white fw-bold"><i class="bi bi-graph-up"></i> M√©triques Quantitatives</div>';
                html += '<div class="card-body"><table class="table table-sm table-borderless mb-0">';
                Object.entries(quantitatives).forEach(([key, value]) => {
                    const label = key.replace(/_/g, ' ').replace(/\b\w/g, (l) => l.toUpperCase());
                    html += `<tr><td class="fw-bold">${escapeHtml(label)}:</td><td>${escapeHtml(valueToString(value))}</td></tr>`;
                });
                html += '</table></div></div></div>';
            }

            // M√©triques qualitatives (g√©rer les deux formats : qualitatives OU qualitatif)
            const qualitatives = principal.metriques.qualitatives || principal.metriques.qualitatif;
            if (qualitatives && Object.keys(qualitatives).length > 0) {
                html += '<div class="col-md-6">';
                html += '<div class="card h-100 border-success">';
                html += '<div class="card-header bg-success text-white fw-bold"><i class="bi bi-clipboard-check"></i> M√©triques Qualitatives</div>';
                html += '<div class="card-body"><table class="table table-sm table-borderless mb-0">';
                Object.entries(qualitatives).forEach(([key, value]) => {
                    const label = key.replace(/_/g, ' ').replace(/\b\w/g, (l) => l.toUpperCase());
                    html += `<tr><td class="fw-bold">${escapeHtml(label)}:</td><td>${escapeHtml(valueToString(value))}</td></tr>`;
                });
                html += '</table></div></div></div>';
            }
        }

        // === Colonne 1 : Budget Analysis ===
        html += '<div class="col-md-6">';
        html += '<div class="card h-100 border-success">';
        html += '<div class="card-header bg-success text-white fw-bold"><i class="bi bi-cash-stack"></i> Analyse Budget</div>';
        html += '<div class="card-body">';

        if (results.budget_analysis) {
            const budget = results.budget_analysis;
            html += '<table class="table table-sm table-borderless mb-0">';

            if (budget.budget_per_month !== undefined) {
                html += `<tr><td class="fw-bold">Budget mensuel :</td><td>${escapeHtml(String(budget.budget_per_month))} ‚Ç¨</td></tr>`;
            }
            if (budget.budget_per_day !== undefined) {
                html += `<tr><td class="fw-bold">Budget journalier :</td><td>${escapeHtml(String(budget.budget_per_day))} ‚Ç¨</td></tr>`;
            }
            if (budget.total_budget !== undefined) {
                html += `<tr><td class="fw-bold">Budget total :</td><td>${escapeHtml(String(budget.total_budget))} ‚Ç¨</td></tr>`;
            }
            if (budget.adequacy) {
                html += `<tr><td colspan="2"><span class="badge bg-info">${escapeHtml(budget.adequacy)}</span></td></tr>`;
            }
            if (budget.recommendations?.length > 0) {
                html += '<tr><td colspan="2" class="pt-2"><small class="text-muted fw-bold">Recommandations :</small><ul class="small mb-0">';
                budget.recommendations.forEach((rec) => {
                    html += `<li>${escapeHtml(String(rec))}</li>`;
                });
                html += '</ul></td></tr>';
            }

            html += '</table>';
        } else {
            html += '<p class="text-muted mb-0">Aucune donn√©e disponible</p>';
        }

        html += '</div></div></div>';

        // === Colonne 2 : Timeline Analysis ===
        html += '<div class="col-md-6">';
        html += '<div class="card h-100 border-primary">';
        html += '<div class="card-header bg-primary text-white fw-bold"><i class="bi bi-calendar-range"></i> Analyse Timeline</div>';
        html += '<div class="card-body">';

        if (results.timeline_analysis) {
            const timeline = results.timeline_analysis;
            html += '<table class="table table-sm table-borderless mb-0">';

            if (timeline.campaign_weeks !== undefined) {
                html += `<tr><td class="fw-bold">Dur√©e campagne :</td><td>${escapeHtml(String(timeline.campaign_weeks))} semaines</td></tr>`;
            }
            if (timeline.campaign_months !== undefined) {
                html += `<tr><td class="fw-bold">Dur√©e campagne :</td><td>${escapeHtml(String(timeline.campaign_months))} mois</td></tr>`;
            }
            if (timeline.adequacy) {
                html += `<tr><td colspan="2"><span class="badge bg-info">${escapeHtml(timeline.adequacy)}</span></td></tr>`;
            }
            if (timeline.milestones?.length > 0) {
                html += '<tr><td colspan="2" class="pt-2"><small class="text-muted fw-bold">Jalons :</small><ul class="small mb-0">';
                timeline.milestones.forEach((milestone) => {
                    html += `<li>${escapeHtml(String(milestone))}</li>`;
                });
                html += '</ul></td></tr>';
            }
            if (timeline.recommendations?.length > 0) {
                html += '<tr><td colspan="2" class="pt-2"><small class="text-muted fw-bold">Recommandations :</small><ul class="small mb-0">';
                timeline.recommendations.forEach((rec) => {
                    html += `<li>${escapeHtml(String(rec))}</li>`;
                });
                html += '</ul></td></tr>';
            }

            html += '</table>';
        } else {
            html += '<p class="text-muted mb-0">Aucune donn√©e disponible</p>';
        }

        html += '</div></div></div>';

        html += '</div>'; // Fin row

        // === Deuxi√®me ligne : Consistency Score + Infos Technique ===
        html += '<div class="row g-3 mt-2">';

        // Consistency Score
        if (results.consistency_score !== undefined) {
            html += '<div class="col-md-6">';
            html += '<div class="card border-warning">';
            html += '<div class="card-header bg-warning text-dark fw-bold"><i class="bi bi-speedometer2"></i> Score de Coh√©rence</div>';
            html += '<div class="card-body text-center">';
            const score = parseFloat(results.consistency_score);
            const percentage = Math.round(score * 100);
            const colorClass = percentage >= 80 ? 'success' : percentage >= 60 ? 'warning' : 'danger';
            html += `<h1 class="display-3 text-${colorClass} mb-0">${percentage}%</h1>`;
            html += '<p class="text-muted mb-0">Coh√©rence globale du projet</p>';
            html += '</div></div></div>';
        }

        // Infos Techniques (tokens, dur√©e, mod√®le)
        html += '<div class="col-md-6">';
        html += '<div class="card border-secondary">';
        html += '<div class="card-header bg-secondary text-white fw-bold"><i class="bi bi-cpu"></i> Informations Techniques</div>';
        html += '<div class="card-body">';
        html += '<table class="table table-sm table-borderless mb-0">';

        if (results.tokens_used) {
            if (results.tokens_used.input !== undefined) {
                html += `<tr><td class="fw-bold">Tokens d'entr√©e :</td><td>${escapeHtml(String(results.tokens_used.input))}</td></tr>`;
            }
            if (results.tokens_used.output !== undefined) {
                html += `<tr><td class="fw-bold">Tokens de sortie :</td><td>${escapeHtml(String(results.tokens_used.output))}</td></tr>`;
            }
            if (results.tokens_used.total !== undefined) {
                html += `<tr><td class="fw-bold">Total tokens :</td><td class="text-primary fw-bold">${escapeHtml(String(results.tokens_used.total))}</td></tr>`;
            }
        }
        if (results.duration_ms !== undefined) {
            const seconds = (results.duration_ms / 1000).toFixed(2);
            html += `<tr><td class="fw-bold">Dur√©e traitement :</td><td>${seconds}s</td></tr>`;
        }
        if (results.model_used) {
            html += `<tr><td class="fw-bold">Mod√®le IA :</td><td><code class="small">${escapeHtml(results.model_used)}</code></td></tr>`;
        }

        html += '</table>';
        html += '</div></div></div>';

        html += '</div>'; // Fin row

        // === Warnings si pr√©sents ===
        if (results.warnings?.length > 0) {
            html += '<div class="row mt-3"><div class="col-12">';
            html += '<div class="card border-danger">';
            html += '<div class="card-header bg-danger text-white fw-bold"><i class="bi bi-exclamation-triangle-fill"></i> Avertissements</div>';
            html += '<div class="card-body"><ul class="mb-0">';
            results.warnings.forEach((warning) => {
                html += `<li class="text-danger">${escapeHtml(String(warning))}</li>`;
            });
            html += '</ul></div></div></div></div>';
        }

        container.innerHTML = html;
    }

    /**
     * Convertit une valeur en cha√Æne de caract√®res s√©curis√©e
     * @param {*} value - Valeur √† convertir
     * @returns {string} Cha√Æne de caract√®res
     */
    function valueToString(value) {
        if (value === null || value === undefined) {
            return '';
        }
        if (typeof value === 'string') {
            return value;
        }
        if (typeof value === 'number' || typeof value === 'boolean') {
            return String(value);
        }
        // Pour les objets et tableaux, retourner une cha√Æne vide plut√¥t que [object Object]
        return '';
    }

    /**
     * Affiche les recommandations strat√©giques (g√®re objets et cha√Ænes)
     * @param {string} containerId - ID du conteneur
     * @param {Array} recommendations - Liste des recommandations
     */
    function renderRecommendations(containerId, recommendations) {
        const container = document.getElementById(containerId);

        if (!recommendations || recommendations.length === 0) {
            container.innerHTML = '<p class="text-muted">Aucune recommandation disponible</p>';
            return;
        }

        const html = recommendations
            .map((rec) => {
                if (typeof rec === 'string') {
                    return `<li class="text-success mb-3">${escapeHtml(rec)}</li>`;
                } else if (typeof rec === 'object' && rec.action) {
                    const action = valueToString(rec.action);
                    let detailsHtml = '';

                    // Justification (peut √™tre une cha√Æne, un tableau OU un objet)
                    if (rec.justification) {
                        if (Array.isArray(rec.justification) && rec.justification.length > 0) {
                            detailsHtml += '<br><small class="text-muted fw-bold">Justification :</small><ul class="small text-muted mt-1 mb-1">';
                            rec.justification.forEach((just) => {
                                detailsHtml += `<li>${escapeHtml(valueToString(just))}</li>`;
                            });
                            detailsHtml += '</ul>';
                        } else if (typeof rec.justification === 'string') {
                            detailsHtml += `<br><small class="text-muted">${escapeHtml(rec.justification)}</small>`;
                        } else if (typeof rec.justification === 'object') {
                            detailsHtml += '<br><small class="text-muted fw-bold">Justification :</small><ul class="small text-muted mt-1 mb-1">';
                            Object.entries(rec.justification).forEach(([key, value]) => {
                                const label = key.replace(/_/g, ' ').replace(/\b\w/g, (l) => l.toUpperCase());
                                detailsHtml += `<li><strong>${escapeHtml(label)}:</strong> ${escapeHtml(valueToString(value))}</li>`;
                            });
                            detailsHtml += '</ul>';
                        }
                    }

                    // M√©triques attendues (array) OU m√©triques associ√©es (objet)
                    if (rec.metriques_attendues && Array.isArray(rec.metriques_attendues) && rec.metriques_attendues.length > 0) {
                        detailsHtml += '<br><small class="text-muted fw-bold">M√©triques attendues :</small><ul class="small text-muted mt-1 mb-1">';
                        rec.metriques_attendues.forEach((metrique) => {
                            detailsHtml += `<li>${escapeHtml(valueToString(metrique))}</li>`;
                        });
                        detailsHtml += '</ul>';
                    } else if (rec.metriques_associ√©es && typeof rec.metriques_associ√©es === 'object') {
                        detailsHtml += '<br><small class="text-muted fw-bold">M√©triques associ√©es :</small><ul class="small text-muted mt-1 mb-1">';
                        Object.entries(rec.metriques_associ√©es).forEach(([key, value]) => {
                            const label = key.replace(/_/g, ' ').replace(/\b\w/g, (l) => l.toUpperCase());
                            detailsHtml += `<li><strong>${escapeHtml(label)}:</strong> ${escapeHtml(valueToString(value))}</li>`;
                        });
                        detailsHtml += '</ul>';
                    }

                    // Autres champs (implementation, outils, logistique, selection, parcours_type, etc.)
                    const extraKeys = [
                        'implementation',
                        'outils',
                        'logistique',
                        'selection',
                        'parcours_type',
                        'budget',
                        'timing',
                    ];
                    extraKeys.forEach((key) => {
                        if (rec[key]) {
                            const label = key.replace(/_/g, ' ').replace(/^\w/, (c) => c.toUpperCase());

                            if (Array.isArray(rec[key]) && rec[key].length > 0) {
                                detailsHtml += `<small class="text-muted fw-bold">${label} :</small><ul class="small text-muted mt-1 mb-1">`;
                                rec[key].forEach((item) => {
                                    detailsHtml += `<li>${escapeHtml(valueToString(item))}</li>`;
                                });
                                detailsHtml += '</ul>';
                            } else if (typeof rec[key] === 'object') {
                                detailsHtml += `<small class="text-muted fw-bold">${label} :</small><ul class="small text-muted mt-1 mb-1">`;
                                Object.entries(rec[key]).forEach(([k, v]) => {
                                    detailsHtml += `<li><strong>${k.replace(/_/g, ' ')}:</strong> ${escapeHtml(valueToString(v))}</li>`;
                                });
                                detailsHtml += '</ul>';
                            } else if (typeof rec[key] === 'string') {
                                detailsHtml += `<br><small class="text-muted"><strong>${label}:</strong> ${escapeHtml(rec[key])}</small>`;
                            }
                        }
                    });

                    return `
                        <li class="text-success mb-3">
                            <strong>${escapeHtml(action)}</strong>
                            ${detailsHtml}
                        </li>
                    `;
                }
                return '';
            })
            .join('');

        container.innerHTML = `<ul class="mb-0">${html}</ul>`;
    }

    /**
     * Affiche les facteurs cl√©s de succ√®s (g√®re objets et cha√Ænes)
     * @param {string} containerId - ID du conteneur
     * @param {Array} factors - Liste des facteurs
     */
    function renderSuccessFactors(containerId, factors) {
        const container = document.getElementById(containerId);

        if (!factors || factors.length === 0) {
            container.innerHTML = '<p class="text-muted">Aucun facteur disponible</p>';
            return;
        }

        const html = factors
            .map((factor) => {
                if (typeof factor === 'string') {
                    return `<li class="text-info mb-3">${escapeHtml(factor)}</li>`;
                } else if (typeof factor === 'object' && factor.facteur) {
                    const facteurText = valueToString(factor.facteur);
                    let detailsHtml = '';

                    // Afficher les indicateurs si pr√©sents
                    if (factor.indicateurs && Array.isArray(factor.indicateurs) && factor.indicateurs.length > 0) {
                        detailsHtml += '<br><small class="text-muted fw-bold">Indicateurs :</small><ul class="small text-muted mt-1 mb-1">';
                        factor.indicateurs.forEach((ind) => {
                            detailsHtml += `<li>${escapeHtml(valueToString(ind))}</li>`;
                        });
                        detailsHtml += '</ul>';
                    }

                    // Afficher les actions pr√©ventives/correctives/proactives si pr√©sentes
                    const actionsKeys = [
                        'actions_preventives',
                        'actions_correctives',
                        'actions_proactives',
                        'optimisations',
                        'outils',
                    ];
                    actionsKeys.forEach((key) => {
                        if (factor[key] && Array.isArray(factor[key]) && factor[key].length > 0) {
                            const label = key.replace(/_/g, ' ').replace(/^\w/, (c) => c.toUpperCase());
                            detailsHtml += `<small class="text-muted fw-bold">${label} :</small><ul class="small text-muted mt-1 mb-1">`;
                            factor[key].forEach((action) => {
                                detailsHtml += `<li>${escapeHtml(valueToString(action))}</li>`;
                            });
                            detailsHtml += '</ul>';
                        }
                    });

                    return `
                        <li class="text-info mb-3">
                            <strong>${escapeHtml(facteurText)}</strong>
                            ${detailsHtml}
                        </li>
                    `;
                }
                return '';
            })
            .join('');

        container.innerHTML = `<ul class="mb-0">${html}</ul>`;
    }

    /**
     * √âchappe le HTML pour pr√©venir XSS
     * @param {string} text - Texte √† √©chapper
     * @returns {string} Texte √©chapp√©
     */
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    /**
     * Affiche un message d'erreur dans la modal
     * @param {string} message - Message d'erreur
     */
    function showError(message) {
        document.getElementById('enrichmentLoader').style.display = 'none';
        document.getElementById('enrichmentResults').style.display = 'none';
        document.getElementById('enrichmentError').style.display = 'block';
        document.getElementById('errorMessage').textContent = message;
    }

    // === EVENT: Accepter les suggestions ===
    document.getElementById('acceptEnrichmentBtn').addEventListener('click', () => {
        if (!currentTaskId) {
            console.error('‚ùå Pas de taskId disponible');
            return;
        }

        acceptEnrichment();
    });

    /**
     * Accepte et applique les suggestions d'enrichissement
     */
    function acceptEnrichment() {
        const selectedNameRadio = document.querySelector('input[name="selectedName"]:checked');
        const selectedNameIndex = selectedNameRadio ? parseInt(selectedNameRadio.value) : 0;
        const selectedName = alternativeNames[selectedNameIndex] || alternativeNames[0];

        // R√©cup√©rer les objectifs depuis currentEnrichedObjectives (stock√© lors de displayResults)
        const objectives = window.currentEnrichedObjectives || '';

        console.log('üì§ Envoi acceptation enrichissement:', {
            taskId: currentTaskId,
            selectedName: selectedName,
            objectivesLength: objectives.length,
        });

        const acceptBtn = document.getElementById('acceptEnrichmentBtn');
        acceptBtn.disabled = true;
        acceptBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Cr√©ation en cours...';

        const url = config.enrichmentAcceptUrl.replace('__TASK_ID__', currentTaskId);

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
            },
            body: JSON.stringify({
                name: selectedName,
                detailedObjectives: objectives,
            }),
        })
            .then((response) => response.json())
            .then((data) => {
                if (data.success) {
                    console.log('‚úÖ Projet cr√©√© avec succ√®s, redirection...', data);
                    window.location.href = data.redirectUrl;
                } else {
                    acceptBtn.disabled = false;
                    acceptBtn.innerHTML = '<i class="bi bi-check-circle"></i> Cr√©er le projet avec ces suggestions';
                    showError(data.error || 'Erreur lors de la cr√©ation du projet');
                }
            })
            .catch((error) => {
                console.error('‚ùå Erreur acceptation:', error);
                acceptBtn.disabled = false;
                acceptBtn.innerHTML = '<i class="bi bi-check-circle"></i> Cr√©er le projet avec ces suggestions';
                showError('Erreur de connexion au serveur');
            });
    }

    // === EVENT: Fermeture de la modal ===
    document.getElementById('enrichmentModal').addEventListener('hidden.bs.modal', () => {
        closeEventSource();
    });
}

// Auto-initialisation si le DOM est pr√™t
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', autoInit);
} else {
    autoInit();
}

/**
 * Auto-initialisation avec data attributes
 */
function autoInit() {
    const form = document.querySelector('form[name="project"]');
    if (!form) {
        return;
    }

    const config = {
        mercureUrl: form.dataset.mercureUrl || 'http://localhost:82/.well-known/mercure',
        enrichmentResultsUrl: form.dataset.enrichmentResultsUrl || '',
        enrichmentAcceptUrl: form.dataset.enrichmentAcceptUrl || '',
    };

    if (!config.enrichmentResultsUrl || !config.enrichmentAcceptUrl) {
        console.warn("‚ö†Ô∏è URLs d'enrichissement non configur√©es dans data attributes");
        return;
    }

    initMarketingProjectEnrichment(config);
}
