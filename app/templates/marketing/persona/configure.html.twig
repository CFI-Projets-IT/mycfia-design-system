{% extends 'layouts/home.html.twig' %}

{% block title %}Configuration de la génération de personas - {{ project.companyName }}{% endblock %}

{% block content %}
<div class="container" style="max-width: 1400px;">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            {# En-tête avec breadcrumb #}
            <nav aria-label="breadcrumb" class="mb-4">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ path('marketing_project_index') }}">Projets</a></li>
                    <li class="breadcrumb-item"><a href="{{ path('marketing_project_show', {id: project.id}) }}">{{ project.companyName }}</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Configuration personas</li>
                </ol>
            </nav>

            {# Carte principale #}
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="bi bi-people-fill me-2"></i>
                        Configuration de la génération de personas
                    </h4>
                </div>

                <div class="card-body">
                    {# Informations contextuelles #}
                    <div class="alert alert-info mb-4">
                        <h5 class="alert-heading">
                            <i class="bi bi-info-circle me-2"></i>
                            À propos de la génération
                        </h5>
                        <p class="mb-2">
                            Les personas marketing seront générés par intelligence artificielle en fonction des informations de votre projet :
                        </p>
                        <ul class="mb-0">
                            <li><strong>Secteur :</strong> {{ project.sector }}</li>
                            <li><strong>Objectif :</strong> {{ project.goalType.label }}</li>
                            <li><strong>Budget :</strong> {{ project.budget|number_format(2, ',', ' ') }} €</li>
                            <li><strong>Durée :</strong> {{ project.startDate|date('d/m/Y') }} → {{ project.endDate|date('d/m/Y') }}</li>
                        </ul>
                    </div>

                    {# Formulaire de configuration #}
                    {{ form_start(form, {
                        'action': path('marketing_persona_generate', {id: project.id}),
                        'method': 'POST',
                        'attr': {'id': 'persona-config-form'}
                    }) }}

                        <div class="mb-4">
                            {{ form_row(form.count, {
                                'label_attr': {'class': 'form-label fw-bold'},
                                'attr': {'class': 'form-select form-select-lg'}
                            }) }}

                            {# Estimation visuelle #}
                            <div class="mt-3 p-3 bg-light rounded" id="estimation-box">
                                <div class="row text-center">
                                    <div class="col-md-4">
                                        <div class="small text-muted">Durée estimée</div>
                                        <div class="h5 mb-0" id="estimated-duration">~85 secondes</div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="small text-muted">Coût approximatif</div>
                                        <div class="h5 mb-0 text-success" id="estimated-cost">~0.04 $</div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="small text-muted">Diversité</div>
                                        <div class="h5 mb-0" id="diversity-level">
                                            <i class="bi bi-star-fill text-warning"></i>
                                            <i class="bi bi-star-fill text-warning"></i>
                                            <i class="bi bi-star-half text-warning"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {# Options avancées (collapsible) #}
                        <div class="accordion mb-4" id="advancedOptions">
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#advancedOptionsCollapse">
                                        <i class="bi bi-sliders me-2"></i>
                                        Options avancées
                                    </button>
                                </h2>
                                <div id="advancedOptionsCollapse" class="accordion-collapse collapse" data-bs-parent="#advancedOptions">
                                    <div class="accordion-body">
                                        {{ form_row(form.minQualityScore, {
                                            'label_attr': {'class': 'form-label fw-bold'},
                                            'attr': {'class': 'form-select'}
                                        }) }}

                                        <div class="alert alert-warning mt-3 mb-0">
                                            <small>
                                                <i class="bi bi-exclamation-triangle me-1"></i>
                                                Un seuil de qualité élevé peut réduire le nombre de personas générés si les critères ne sont pas atteints.
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {# Boutons d'action #}
                        <div class="d-flex justify-content-between align-items-center">
                            <a href="{{ path('marketing_project_show', {id: project.id}) }}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left me-1"></i>
                                Retour au projet
                            </a>

                            <button type="submit" class="btn btn-primary btn-lg" id="submit-btn">
                                <i class="bi bi-magic me-2"></i>
                                Lancer la génération
                            </button>
                        </div>

                        {{ form_rest(form) }}
                    {{ form_end(form) }}
                </div>

                <div class="card-footer text-muted">
                    <small>
                        <i class="bi bi-lightbulb me-1"></i>
                        <strong>Conseil :</strong> Pour une campagne marketing optimale, nous recommandons de générer au moins 3 personas pour couvrir différents segments de votre audience cible.
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

{# Script pour mise à jour dynamique des estimations #}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const countSelect = document.getElementById('persona_generation_config_count');
    const estimatedDuration = document.getElementById('estimated-duration');
    const estimatedCost = document.getElementById('estimated-cost');
    const diversityLevel = document.getElementById('diversity-level');

    // Données d'estimation par nombre de personas
    const estimations = {
        1: { duration: '~30 secondes', cost: '~0.015 $', diversity: 1 },
        3: { duration: '~85 secondes', cost: '~0.04 $', diversity: 2 },
        5: { duration: '~140 secondes', cost: '~0.065 $', diversity: 3 },
        10: { duration: '~280 secondes', cost: '~0.13 $', diversity: 4 }
    };

    function updateEstimations() {
        const count = parseInt(countSelect.value);
        const data = estimations[count];

        if (data) {
            estimatedDuration.textContent = data.duration;
            estimatedCost.textContent = data.cost;

            // Mise à jour des étoiles de diversité
            let stars = '';
            for (let i = 1; i <= 4; i++) {
                if (i <= data.diversity) {
                    stars += '<i class="bi bi-star-fill text-warning"></i> ';
                } else if (i === data.diversity + 1 && count < 10) {
                    stars += '<i class="bi bi-star-half text-warning"></i> ';
                } else {
                    stars += '<i class="bi bi-star text-muted"></i> ';
                }
            }
            diversityLevel.innerHTML = stars.trim();
        }
    }

    // Écouter les changements de sélection
    countSelect.addEventListener('change', updateEstimations);

    // Initialiser avec la valeur par défaut
    updateEstimations();

    // Animation du bouton de soumission
    const form = document.getElementById('persona-config-form');
    const submitBtn = document.getElementById('submit-btn');

    form.addEventListener('submit', function() {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Lancement en cours...';
    });
});
</script>
{% endblock %}
