{% extends 'layouts/home.html.twig' %}

{% block title %}Chat IA - myCFiia{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('styles/components/chat-nav-tabs.css') }}">
    <link rel="stylesheet" href="{{ asset('styles/components/chat-messages.css') }}">
    <link rel="stylesheet" href="{{ asset('styles/components/chat-input.css') }}">
    <link rel="stylesheet" href="{{ asset('styles/components/data-table.css') }}">
    <link rel="stylesheet" href="{{ asset('styles/chat.css') }}">
{% endblock %}

{% block navigation %}
{# Navigation Tabs - Positionn√©e juste apr√®s le header, avant le contenu #}
{{ component('ChatNavTabs', { context: context }) }}
{% endblock %}

{% block content_classes %} chat-page{% endblock %}

{% block content %}
{# ==================================================================================
   NOUVELLE UI IMMERSIVE CHAT - EN D√âVELOPPEMENT

   ‚ö†Ô∏è IDs JavaScript REQUIS pour chat.js (NE PAS SUPPRIMER) :
   - #chatForm           ‚Üí Formulaire de soumission
   - #chatInput          ‚Üí Textarea de saisie
   - #chatMessages       ‚Üí Conteneur des messages
   - #sendButton         ‚Üí Bouton d'envoi
   - #charCount          ‚Üí Compteur de caract√®res
   - #chatLoading        ‚Üí Indicateur de chargement
   - #clearChat          ‚Üí Bouton nouvelle conversation
   - #exportChat         ‚Üí Bouton export
   - .quick-question     ‚Üí Boutons suggestions (class)

   üìã Variables Twig disponibles :
   - context             ‚Üí Type de chat (factures|commandes|stocks|general)
   - conversationId      ‚Üí UUID de la conversation
   - mercureUrl          ‚Üí URL du hub Mercure
   - mercureJwt          ‚Üí Token JWT pour Mercure
   - app.user.fullName   ‚Üí Nom complet de l'utilisateur
   ================================================================================== #}

{# Zone des messages - Pr√©-remplie si conversation charg√©e depuis BDD #}
<div id="chatMessages" class="chat-messages-container">
    {% if loadedConversation is defined and loadedConversation %}
        {# Messages existants charg√©s depuis la BDD #}
        {% for message in loadedConversation.messages %}
            {% if message.role == 'user' %}
                {# Message utilisateur #}
                <div class="chat-message chat-message-user">
                    <div class="chat-message-content">
                        <div class="chat-message-bubble">
                            {{ message.content|nl2br }}
                        </div>
                    </div>
                    <div class="chat-message-avatar">
                        <i class="bi bi-person-fill"></i>
                    </div>
                </div>
            {% else %}
                {# Message assistant #}
                <div class="chat-message chat-message-assistant">
                    <div class="chat-message-bubble">
                        <img src="{{ asset('images/assistant-picto.svg') }}" alt="IA" class="chat-message-logo">
                        <div class="chat-message-text">
                            {{ message.content|nl2br }}
                        </div>
                    </div>
                </div>
                {# Si le message contient des donn√©es de tableau #}
                {% if message.type == 'table' and message.data.table_data is defined %}
                    <div class="chat-message chat-message-assistant mt-3">
                        <div class="chat-message-bubble">
                            <img src="{{ asset('images/assistant-picto.svg') }}" alt="IA" class="chat-message-logo">
                            <div class="chat-message-text">
                                {{ component('DataTable', {
                                    headers: message.data.table_data.headers,
                                    rows: message.data.table_data.rows,
                                    totalRow: message.data.table_data.totalRow|default(null),
                                    linkColumns: message.data.table_data.linkColumns|default({}),
                                    mode: message.data.table_data.mode|default('LISTE')
                                }) }}
                            </div>
                        </div>
                    </div>
                {% endif %}
            {% endif %}
        {% endfor %}
    {% else %}
        {# Les messages seront ins√©r√©s ici dynamiquement via JavaScript #}
    {% endif %}
</div>

{# ==================================================================================
   DONN√âES JAVASCRIPT - ABSOLUMENT CRITIQUE - NE JAMAIS SUPPRIMER
   Ce div invisible injecte la configuration dans chat.js via data attributes
   ================================================================================== #}
<div id="chatData"
     data-context="{{ context }}"
     data-conversation-id="{{ conversationId }}"
     data-mercure-url="{{ mercureUrl }}"
     data-mercure-jwt="{{ mercureJwt }}"
     data-message-url="{{ path('chat_message', {context: context}) }}"
     data-stream-url="{{ path('chat_stream', {context: context}) }}"
     data-assistant-logo="{{ asset('images/assistant-picto.svg') }}"
     {% if loadedConversation is defined and loadedConversation %}
     data-loaded-conversation="{{ loadedConversation.id }}"
     data-is-favorite="{{ loadedConversation.isFavorite ? '1' : '0' }}"
     data-favorite-url="{{ path('chat_toggle_favorite', {id: loadedConversation.id}) }}"
     data-delete-url="{{ path('chat_delete_conversation', {id: loadedConversation.id}) }}"
     {% endif %}
     style="display: none;">
</div>
{% endblock %}

{% block sticky_bottom %}
{# CONTAINER 3 : Input fixe en bas #}
<div class="sticky-bottom-container">
    {{ component('ChatInput', { context: context }) }}
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script type="module" src="{{ asset('js/chat.js') }}"></script>
{% endblock %}
