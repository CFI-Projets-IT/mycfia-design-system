{% extends 'layouts/home.html.twig' %}

{% block title %}Chat IA - myCFiia{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('styles/chat.css') }}">
{% endblock %}

{% block content %}
<div class="chat-container d-flex flex-column h-100">
    {# Header du chat avec titre et actions #}
    <div class="chat-header px-4 py-3 border-bottom">
        <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center gap-3">
                <div class="chat-avatar">
                    <i class="bi bi-robot fs-3 text-primary"></i>
                </div>
                <div>
                    <h1 class="h5 mb-0 fw-semibold text-primary">
                        Assistant IA -
                        {% if context == 'factures' %}
                            <span class="badge bg-info">Factures</span>
                        {% elseif context == 'commandes' %}
                            <span class="badge bg-success">Commandes</span>
                        {% elseif context == 'stocks' %}
                            <span class="badge bg-warning">Stocks</span>
                        {% else %}
                            <span class="badge bg-primary">GÃ©nÃ©ral</span>
                        {% endif %}
                    </h1>
                    <p class="small text-muted mb-0">
                        <i class="bi bi-circle-fill text-success" style="font-size: 0.5rem;"></i>
                        En ligne - Contexte {{ context|capitalize }}
                    </p>
                </div>
            </div>
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-sm btn-outline-secondary" id="clearChat" title="Nouvelle conversation">
                    <i class="bi bi-plus-circle"></i>
                    <span class="d-none d-md-inline ms-1">Nouveau</span>
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary" id="exportChat" title="Exporter la conversation">
                    <i class="bi bi-download"></i>
                    <span class="d-none d-md-inline ms-1">Exporter</span>
                </button>
            </div>
        </div>
    </div>

    {# Zone des messages - Scroll automatique #}
    <div class="chat-messages flex-grow-1 overflow-auto px-4 py-4" id="chatMessages">
        {# Message de bienvenue #}
        <div class="chat-message assistant-message mb-4" data-message-type="assistant">
            <div class="d-flex gap-3">
                <div class="message-avatar flex-shrink-0">
                    <i class="bi bi-robot text-primary"></i>
                </div>
                <div class="message-content flex-grow-1">
                    <div class="message-header mb-2">
                        <span class="fw-semibold text-primary">Assistant IA</span>
                        <span class="small text-muted ms-2">{{ 'now'|date('H:i') }}</span>
                    </div>
                    <div class="message-text">
                        <p class="mb-2">Bonjour <strong>{{ app.user.fullName }}</strong> ! ğŸ‘‹</p>
                        {% if context == 'factures' %}
                            <p class="mb-3">Je suis votre assistant spÃ©cialisÃ© <strong>Factures</strong>. Je peux vous aider Ã  :</p>
                            <ul class="mb-3">
                                <li>ğŸ“Š Consulter vos <strong>factures clients</strong> (courrier et email)</li>
                                <li>ğŸ’° Suivre les <strong>paiements</strong> et factures impayÃ©es</li>
                                <li>ğŸ“ˆ Analyser vos <strong>statistiques de facturation</strong></li>
                                <li>ğŸ“… Rechercher par pÃ©riode ou rÃ©fÃ©rence</li>
                            </ul>
                        {% elseif context == 'commandes' %}
                            <p class="mb-3">Je suis votre assistant spÃ©cialisÃ© <strong>Commandes</strong>. Je peux vous aider Ã  :</p>
                            <ul class="mb-3">
                                <li>ğŸ“¦ Consulter vos <strong>commandes clients</strong></li>
                                <li>ğŸšš Suivre les <strong>livraisons</strong> et statuts</li>
                                <li>ğŸ“ˆ Analyser vos <strong>statistiques de commandes</strong></li>
                                <li>ğŸ” Rechercher commandes par client ou rÃ©fÃ©rence</li>
                            </ul>
                        {% elseif context == 'stocks' %}
                            <p class="mb-3">Je suis votre assistant spÃ©cialisÃ© <strong>Stocks</strong>. Je peux vous aider Ã  :</p>
                            <ul class="mb-3">
                                <li>ğŸ“¦ VÃ©rifier l'Ã©tat de vos <strong>stocks</strong></li>
                                <li>âš ï¸ Identifier les <strong>alertes de rÃ©approvisionnement</strong></li>
                                <li>ğŸ“Š Consulter les quantitÃ©s disponibles par rÃ©fÃ©rence</li>
                                <li>ğŸ” Rechercher stocks critiques ou faibles</li>
                            </ul>
                        {% else %}
                            <p class="mb-3">Je suis votre assistant <strong>GÃ©nÃ©raliste</strong>. Je peux vous aider Ã  :</p>
                            <ul class="mb-3">
                                <li>ğŸ“Š Consulter vos <strong>opÃ©rations marketing</strong> (SMS, Email, Courrier)</li>
                                <li>ğŸ“¦ VÃ©rifier l'Ã©tat de vos <strong>stocks</strong> et les alertes</li>
                                <li>ğŸ“ˆ Analyser vos <strong>statistiques</strong> et performances</li>
                                <li>â“ RÃ©pondre Ã  vos questions transverses sur vos donnÃ©es CFI</li>
                            </ul>
                        {% endif %}
                        <p class="mb-0 text-muted small">
                            <i class="bi bi-lightbulb"></i>
                            <em>Posez-moi une question, je suis connectÃ© Ã  vos donnÃ©es en temps rÃ©el !</em>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        {# Les messages dynamiques seront insÃ©rÃ©s ici par JavaScript #}
    </div>

    {# Zone de saisie - Fixed en bas #}
    <div class="chat-input-container border-top bg-light">
        <div class="px-4 py-3">
            <form id="chatForm" class="d-flex gap-2">
                <div class="flex-grow-1 position-relative">
                    <textarea
                        id="chatInput"
                        class="form-control chat-textarea"
                        placeholder="Posez votre question ici... (Ex: Combien d'opÃ©rations SMS ce mois-ci ?)"
                        rows="1"
                        style="resize: none; overflow-y: hidden;"
                    ></textarea>
                    <div class="position-absolute bottom-0 end-0 p-2">
                        <small class="text-muted" id="charCount">0 / 500</small>
                    </div>
                </div>
                <button
                    type="submit"
                    class="btn btn-primary d-flex align-items-center gap-2"
                    id="sendButton"
                    disabled
                >
                    <i class="bi bi-send-fill"></i>
                    <span class="d-none d-md-inline">Envoyer</span>
                </button>
            </form>

            {# Suggestions de questions contextuelles #}
            <div class="mt-3" id="quickQuestions">
                <div class="d-flex flex-wrap gap-2">
                    <span class="small text-muted me-2">Suggestions :</span>
                    {% if context == 'factures' %}
                        <button type="button" class="btn btn-sm btn-outline-info quick-question" data-question="DerniÃ¨res factures ce mois ?">
                            <i class="bi bi-receipt"></i> Factures du mois
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-info quick-question" data-question="Factures impayÃ©es ?">
                            <i class="bi bi-exclamation-circle"></i> ImpayÃ©es
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-info quick-question" data-question="Total facturÃ© en janvier 2025 ?">
                            <i class="bi bi-bar-chart"></i> Stats janvier
                        </button>
                    {% elseif context == 'commandes' %}
                        <button type="button" class="btn btn-sm btn-outline-success quick-question" data-question="DerniÃ¨res commandes clients ?">
                            <i class="bi bi-box-seam"></i> DerniÃ¨res commandes
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-success quick-question" data-question="Commandes en cours de traitement">
                            <i class="bi bi-hourglass-split"></i> En cours
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-success quick-question" data-question="Statistiques commandes ce mois">
                            <i class="bi bi-graph-up"></i> Stats mois
                        </button>
                    {% elseif context == 'stocks' %}
                        <button type="button" class="btn btn-sm btn-outline-warning quick-question" data-question="Ã‰tat des stocks actuels ?">
                            <i class="bi bi-boxes"></i> Ã‰tat stocks
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-warning quick-question" data-question="Stocks nÃ©cessitant un rÃ©approvisionnement ?">
                            <i class="bi bi-exclamation-triangle"></i> Alertes
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-warning quick-question" data-question="Stocks en situation critique ?">
                            <i class="bi bi-dash-circle"></i> Critiques
                        </button>
                    {% else %}
                        <button type="button" class="btn btn-sm btn-outline-primary quick-question" data-question="Combien d'opÃ©rations SMS ce mois-ci ?">
                            <i class="bi bi-chat-dots"></i> SMS du mois
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-primary quick-question" data-question="Quels sont les stocks en alerte ?">
                            <i class="bi bi-exclamation-triangle"></i> Alertes stocks
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-primary quick-question" data-question="ActivitÃ© commerciale cette semaine ?">
                            <i class="bi bi-bar-chart"></i> ActivitÃ© semaine
                        </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {# Indicateur de chargement #}
    <div class="chat-loading d-none" id="chatLoading">
        <div class="d-flex align-items-center gap-2 text-muted">
            <div class="spinner-border spinner-border-sm" role="status">
                <span class="visually-hidden">Chargement...</span>
            </div>
            <span>L'assistant rÃ©flÃ©chit...</span>
        </div>
    </div>
</div>

{# DonnÃ©es pour JavaScript #}
<div id="chatData"
     data-context="{{ context }}"
     data-conversation-id="{{ conversationId }}"
     data-mercure-url="{{ mercureUrl }}"
     data-mercure-jwt="{{ mercureJwt }}"
     data-message-url="{{ path('chat_message', {context: context}) }}"
     data-stream-url="{{ path('chat_stream', {context: context}) }}"
     style="display: none;">
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script type="module" src="{{ asset('js/chat.js') }}"></script>
{% endblock %}
