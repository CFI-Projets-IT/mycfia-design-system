{% extends 'layouts/home.html.twig' %}

{% block title %}Chat IA - myCFiia{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('styles/chat.css') }}">
{% endblock %}

{% block content %}
<div class="chat-container d-flex flex-column h-100">
    {# Header du chat avec titre et actions #}
    <div class="chat-header px-4 py-3 border-bottom">
        <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center gap-3">
                <div class="chat-avatar">
                    <i class="bi bi-robot fs-3 text-primary"></i>
                </div>
                <div>
                    <h1 class="h5 mb-0 fw-semibold text-primary">Assistant IA myCFiia</h1>
                    <p class="small text-muted mb-0">
                        <i class="bi bi-circle-fill text-success" style="font-size: 0.5rem;"></i>
                        En ligne
                    </p>
                </div>
            </div>
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-sm btn-outline-secondary" id="clearChat" title="Nouvelle conversation">
                    <i class="bi bi-plus-circle"></i>
                    <span class="d-none d-md-inline ms-1">Nouveau</span>
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary" id="exportChat" title="Exporter la conversation">
                    <i class="bi bi-download"></i>
                    <span class="d-none d-md-inline ms-1">Exporter</span>
                </button>
            </div>
        </div>
    </div>

    {# Zone des messages - Scroll automatique #}
    <div class="chat-messages flex-grow-1 overflow-auto px-4 py-4" id="chatMessages">
        {# Message de bienvenue #}
        <div class="chat-message assistant-message mb-4" data-message-type="assistant">
            <div class="d-flex gap-3">
                <div class="message-avatar flex-shrink-0">
                    <i class="bi bi-robot text-primary"></i>
                </div>
                <div class="message-content flex-grow-1">
                    <div class="message-header mb-2">
                        <span class="fw-semibold text-primary">Assistant IA</span>
                        <span class="small text-muted ms-2">{{ 'now'|date('H:i') }}</span>
                    </div>
                    <div class="message-text">
                        <p class="mb-2">Bonjour <strong>{{ app.user.fullName }}</strong> ! üëã</p>
                        <p class="mb-3">Je suis votre assistant IA pour myCFiia. Je peux vous aider √† :</p>
                        <ul class="mb-3">
                            <li>üìä Consulter vos <strong>op√©rations marketing</strong> (SMS, Email, Courrier)</li>
                            <li>üì¶ V√©rifier l'√©tat de vos <strong>stocks</strong> et les alertes</li>
                            <li>üìà Analyser vos <strong>statistiques</strong> et performances</li>
                            <li>‚ùì R√©pondre √† vos questions sur vos donn√©es CFI</li>
                        </ul>
                        <p class="mb-0 text-muted small">
                            <i class="bi bi-lightbulb"></i>
                            <em>Posez-moi une question, je suis connect√© √† vos donn√©es en temps r√©el !</em>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        {# Les messages dynamiques seront ins√©r√©s ici par JavaScript #}
    </div>

    {# Zone de saisie - Fixed en bas #}
    <div class="chat-input-container border-top bg-light">
        <div class="px-4 py-3">
            <form id="chatForm" class="d-flex gap-2">
                <div class="flex-grow-1 position-relative">
                    <textarea
                        id="chatInput"
                        class="form-control chat-textarea"
                        placeholder="Posez votre question ici... (Ex: Combien d'op√©rations SMS ce mois-ci ?)"
                        rows="1"
                        style="resize: none; overflow-y: hidden;"
                    ></textarea>
                    <div class="position-absolute bottom-0 end-0 p-2">
                        <small class="text-muted" id="charCount">0 / 500</small>
                    </div>
                </div>
                <button
                    type="submit"
                    class="btn btn-primary d-flex align-items-center gap-2"
                    id="sendButton"
                    disabled
                >
                    <i class="bi bi-send-fill"></i>
                    <span class="d-none d-md-inline">Envoyer</span>
                </button>
            </form>

            {# Suggestions de questions #}
            <div class="mt-3" id="quickQuestions">
                <div class="d-flex flex-wrap gap-2">
                    <span class="small text-muted me-2">Suggestions :</span>
                    <button type="button" class="btn btn-sm btn-outline-secondary quick-question" data-question="Combien d'op√©rations SMS ce mois-ci ?">
                        <i class="bi bi-chat-dots"></i> SMS du mois
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary quick-question" data-question="Quels sont les stocks en alerte ?">
                        <i class="bi bi-exclamation-triangle"></i> Alertes stocks
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary quick-question" data-question="Statistiques des op√©rations par type">
                        <i class="bi bi-bar-chart"></i> Stats op√©rations
                    </button>
                </div>
            </div>
        </div>
    </div>

    {# Indicateur de chargement #}
    <div class="chat-loading d-none" id="chatLoading">
        <div class="d-flex align-items-center gap-2 text-muted">
            <div class="spinner-border spinner-border-sm" role="status">
                <span class="visually-hidden">Chargement...</span>
            </div>
            <span>L'assistant r√©fl√©chit...</span>
        </div>
    </div>
</div>

{# Donn√©es pour JavaScript #}
<div id="chatData"
     data-conversation-id="{{ conversationId }}"
     data-mercure-url="{{ mercureUrl }}"
     data-message-url="{{ path('chat_message') }}"
     data-stream-url="{{ path('chat_stream') }}"
     style="display: none;">
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script type="module" src="{{ asset('js/chat.js') }}"></script>
{% endblock %}
